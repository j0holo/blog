<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="description" content="Space-time trade-off" />
    <title>Space-time trade-off</title>
    <link rel="stylesheet" href="../../styles/blogpost.css" />
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Arpit Batra" />
  </head>
  <body>
    <div class="container post-container">
      <div class="back-link">
        <a href="/">← Back</a>
      </div>
      <h1>Space-time trade-off</h1>
      <div class="content"><p>Today I did some regex check on a string of text.</p>
<p>The regexes are dynamic based on a table in the database. In total there are around 200 different regexes, sometimes looking for a single word sometimes for a combination of words.</p>
<p>If any of the 200 regexes matches with the input string true is returned, otherwise false.</p>
</br>
<details>
  <summary>Code</summary>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> regex_bench<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"fmt"</span><br>	<span class="token string">"regexp"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span>regexes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp<span class="token punctuation">,</span> input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span><br>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> regex <span class="token operator">:=</span> <span class="token keyword">range</span> regexes <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> regex<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> <span class="token boolean">true</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> <span class="token boolean">false</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">calculateRegexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp <span class="token punctuation">{</span><br>	<span class="token keyword">var</span> regexes <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>wordList<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> wordList <span class="token punctuation">{</span><br>		regex<span class="token punctuation">,</span> err <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"^.*\b%s\b.*$"</span><span class="token punctuation">,</span> wordList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> <span class="token boolean">nil</span><br>		<span class="token punctuation">}</span><br>		regexes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> regex<br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> regexes<br><span class="token punctuation">}</span><br><br><span class="token comment">// A string slice with 200 entries of "word &lt;integer between 1 and 200>".</span></code></pre>
</details>
</br>
<details>
  <summary>The benchmark code</summary>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> regex_bench<br><br><span class="token keyword">import</span> <span class="token string">"testing"</span><br><br><span class="token keyword">func</span> <span class="token function">BenchmarkNoPreCompute</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"early match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 2."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span><span class="token function">calculateRegexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"middle match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 100."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span><span class="token function">calculateRegexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"late match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 199."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span><span class="token function">calculateRegexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">BenchmarkPreCompute</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	regexes <span class="token operator">:=</span> <span class="token function">calculateRegexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"early match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 2."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span>regexes<span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"middle match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 100."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span>regexes<span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"late match"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">var</span> foundMatch <span class="token builtin">bool</span><br>		<span class="token keyword">const</span> input <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"This is a string with the word 199."</span><br><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			foundMatch <span class="token operator">=</span> <span class="token function">checkForMatch</span><span class="token punctuation">(</span>regexes<span class="token punctuation">,</span> input<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token operator">!</span>foundMatch <span class="token punctuation">{</span><br>			b<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"match should be found"</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
</details>
</br>
<p>Now for the benchmark results, each test has the same 200 regexes with matches three possible matches at the beginning, middle and end of the regex slice.</p>
<pre class="language-bash"><code class="language-bash">go <span class="token builtin class-name">test</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span>.<br>goos: linux<br>goarch: amd64<br>pkg: regex_bench<br>cpu: AMD Ryzen <span class="token number">7</span> 5800X3D <span class="token number">8</span>-Core Processor           <br>BenchmarkNoPreCompute/early_match-16         	    <span class="token number">1584</span>	   <span class="token number">1010451</span> ns/op<br>BenchmarkNoPreCompute/middle_match-16        	    <span class="token number">1161</span>	    <span class="token number">992859</span> ns/op<br>BenchmarkNoPreCompute/late_match-16          	    <span class="token number">1232</span>	   <span class="token number">1046991</span> ns/op<br>BenchmarkPreCompute/early_match-16           	 <span class="token number">2436992</span>	       <span class="token number">482.5</span> ns/op<br>BenchmarkPreCompute/middle_match-16          	 <span class="token number">2315199</span>	       <span class="token number">509.2</span> ns/op<br>BenchmarkPreCompute/late_match-16            	 <span class="token number">2328488</span>	       <span class="token number">499.1</span> ns/op<br>PASS<br>ok  	regex_bench	<span class="token number">9</span>.402s</code></pre>
<p>This is of course an obvious benchmark but why would you even do this optimization? 500ns is quick but 1046991ns doesn't sound slow. Until you convert it to milliseconds:</p>
<blockquote>
<p>1046991ns ~= 1.04ms</p>
</blockquote>
<p>With a 100 requests a second that is still not a lot of time. What if the list grows and you need to build a 1000 regexes each request for a 1000 requests per second? Maybe it does matter, maybe it doesn't.</p>
<p>Keep it in the back of your mind: can I precompute this? If yes: Is it worth it in speed and readability?</p>
</div>
      <div class="back-link">
        <a href="/">← Back</a>
      </div>
    </div>
  </body>
</html>
