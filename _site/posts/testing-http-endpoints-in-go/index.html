<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="description" content="Testing HTTP endpoints in Go" />
    <title>Testing HTTP endpoints in Go</title>
    <link rel="stylesheet" href="../../styles/blogpost.css" />
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Arpit Batra" />
  </head>
  <body>
    <div class="container post-container">
      <div class="back-link">
        <a href="/">‚Üê Back</a>
      </div>
      <h1>Testing HTTP endpoints in Go</h1>
      <div class="content"><p>Go makes it really easy to test HTTP endpoints with the <code>httptest</code> package. Let's view this in an example and see how easy it is.</p>
<p>Our manager gave us a new task today. He gave us the following specifications:</p>
<ul>
<li>Every response must be of content-type: application/json</li>
<li>The body of POST requests needs to written to disk for analysis later</li>
<li>GET requests returns the content of the file if available</li>
<li>If the file is not available we need to return a 404 Not Found</li>
</ul>
<p>We start with the first bullet-point, starting with a test:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token string">"net/http"</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span><br>	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> mux<br><span class="token punctuation">}</span></code></pre>
<p><em>main.go</em></p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"net/http"</span><br>	<span class="token string">"net/http/httptest"</span><br>	<span class="token string">"testing"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">TestOnlyAcceptsApplicationJSONRequests</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>URL<span class="token operator">+</span><span class="token string">"/json"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusBadRequest <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go</em></p>
<p>Running it with <code>go run .</code> , we get a 404 Not Found, as expected. An easy fix by adding a route, <code>/json</code>. <code>go run .</code> again and it works. Now we update the test to check for the content-type matches with <code>application/json</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token operator">...</span><br><br><span class="token keyword">func</span> <span class="token function">newRouter</span><span class="token punctuation">(</span>app <span class="token operator">*</span>Application<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span><br>	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/json"</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>handleJSON<span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> mux<br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> Application <span class="token keyword">struct</span> <span class="token punctuation">{</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Application<span class="token punctuation">)</span> <span class="token function">handleJSON</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><br>	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><br>	<span class="token keyword">return</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main.go</em></p>
<pre class="language-go"><code class="language-go"><span class="token operator">...</span><br><br><span class="token keyword">func</span> <span class="token function">TestOnlyAcceptsApplicationJSONRequests</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>Application<span class="token punctuation">{</span><span class="token punctuation">}</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>URL<span class="token operator">+</span><span class="token string">"/json"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusBadRequest <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	contentType <span class="token operator">:=</span> resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> contentType <span class="token operator">!=</span> <span class="token string">"application/json"</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"response content-type is not application/json, got %s"</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go</em></p>
<p>One problem gone, three more to go.</p>
<h2>Writing files to disk</h2>
<p>This one is actually a bit more difficult to test without leaving temporary files around. We could use <code>os.WriteFile</code> but that would make testing it more difficult and also leaves around the files we need to clean up after the test.</p>
<p>We have to write some abstraction to fake a os.File that we normally get from <code>os.OpenFile()</code>, fortunately <code>os.File</code> implements a <code>io.WriterCloser</code> which is similar to <code>bytes.Buffer</code> except that <code>bytes.Buffer</code> does not implement the <code>io.Closer</code> interface. By writing some extra code we can mimic writing to a file without creating a file. Let's see how that works.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// In main.go we define the fileOpener interface</span><br><br><span class="token comment">// fileOpener mimics the os.OpenFile but returns an io.WriteCloser instead.</span><br><span class="token keyword">type</span> fileOpener <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main.go - the new interface that we will be using</em></p>
<pre class="language-go"><code class="language-go"><span class="token comment">// In main.go we define the fileOpener interface</span><br><br><span class="token comment">// fileOpener mimics the os.OpenFile but returns an io.WriteCloser instead.</span><br><span class="token keyword">type</span> fileOpener <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go - our test implementation for the fileOpener interface</em></p>
<p>The <code>fileOpener</code> interface gives us the option to implement two versions, one for production and one for testing. <code>osFile.openFile</code> returns <code>os.File</code> which in turn implements the <code>io.WriterCloser</code> as already said earlier.</p>
<p>The <code>fakeFiles</code> and <code>fakeFile</code> structs are our second implementation that together simulate the filesystem and files in a <code>map[string]fakeFile</code> which is stored in the <code>fakeFiles</code> struct. Now we can read what the HTTP handler has written without creating a real file.</p>
<p>This has one problem, instead of testing behavior we are actually also testing the implementation of our handler. Which can make our tests fragile if we change our implementation without changing our behavior.<br>
This is a trade-off I'm willing to make right now. But always keep that in mind when your tests start digging into dependencies that your function/method need.</p>
<p>After using these interfaces our code now looks like this:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"io"</span><br>	<span class="token string">"io/ioutil"</span><br>	<span class="token string">"net/http"</span><br>	<span class="token string">"os"</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// fileOpener mimics the os.OpenFile but returns an io.WriteCloser instead.</span><br><span class="token keyword">type</span> fileOpener <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> osFile <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token comment">// openFile implements the fileOpener interface by returning an *os.File</span><br><span class="token comment">// which implements the io.WriterCloser interface.</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>o osFile<span class="token punctuation">)</span> <span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">newRouter</span><span class="token punctuation">(</span>app <span class="token operator">*</span>Application<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span><br>	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/json"</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>handleJSON<span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> mux<br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> Application <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	fs fileOpener<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Application<span class="token punctuation">)</span> <span class="token function">handleJSON</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodGet <span class="token punctuation">{</span><br>		w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><br>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><br>		<span class="token keyword">return</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodPost <span class="token punctuation">{</span><br>		w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><br><br>		filename <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><br>		fw<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>fs<span class="token punctuation">.</span><span class="token function">openFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">defer</span> fw<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>		data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">defer</span> r<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> fw<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">)</span><br>		<span class="token keyword">return</span><br>	<span class="token punctuation">}</span><br><br><span class="token punctuation">}</span></code></pre>
<p><em>main.go</em></p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"bytes"</span><br>	<span class="token string">"io"</span><br>	<span class="token string">"io/ioutil"</span><br>	<span class="token string">"net/http"</span><br>	<span class="token string">"net/http/httptest"</span><br>	<span class="token string">"os"</span><br>	<span class="token string">"testing"</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// fakeFile implements the io.WriterCloser interface.</span><br><span class="token keyword">type</span> fakeFile <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	buff <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFile<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> f<span class="token punctuation">.</span>buff<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFile<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// fakeFiles mimics the filesystem.</span><br><span class="token keyword">type</span> fakeFiles <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	files <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>fakeFile<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">newFakeFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>fakeFiles <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> <span class="token operator">&amp;</span>fakeFiles<span class="token punctuation">{</span><br>		files<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>fakeFile<span class="token punctuation">)</span><span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>ff <span class="token operator">*</span>fakeFiles<span class="token punctuation">)</span> <span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>WriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> fakeFile<span class="token punctuation">{</span>buff<span class="token punctuation">:</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	<span class="token keyword">return</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">TestOnlyAcceptsApplicationJSONRequests</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>Application<span class="token punctuation">{</span>fs<span class="token punctuation">:</span> <span class="token function">newFakeFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>URL<span class="token operator">+</span><span class="token string">"/json"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusBadRequest <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	contentType <span class="token operator">:=</span> resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> contentType <span class="token operator">!=</span> <span class="token string">"application/json"</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"response content-type is not application/json, got %s"</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">TestWriteFileToDiskOnPostRequest</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	files <span class="token operator">:=</span> <span class="token function">newFakeFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>Application<span class="token punctuation">{</span>fs<span class="token punctuation">:</span> files<span class="token punctuation">}</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	input <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"{\"secret\": \"true\"}"</span><span class="token punctuation">)</span><br><br>	filename <span class="token operator">:=</span> <span class="token string">"test.json"</span><br>	endpoint <span class="token operator">:=</span> ts<span class="token punctuation">.</span>URL <span class="token operator">+</span> <span class="token string">"/json?file="</span> <span class="token operator">+</span> filename<br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusAccepted <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusAccepted<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	written<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>files<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span>buff<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"cannot read file buffer: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>written<span class="token punctuation">,</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"bytes written to file is not equal to input"</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go</em></p>
<h2>Reading files from disk</h2>
<p>For reading files from disk I want to use a similar setup as we used with writing files to disk. The problem is, is that our <code>fileOpener</code> interface does not support reading. Changing it to support reading is fairly easy actually, but our interface needs to support the <code>io.ReadWriteCloser</code> interface.</p>
<p>This is a really easy change because <code>os.File</code> and <code>bytes.Buffer</code> already implement this interface. With a simple update to our <code>fileOpener</code> and implementing the <code>Write(p []byte) (n int, err error)</code> method for <code>fakeFile</code> we are already done to write our test.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">type</span> fileOpener <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> osFile <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>o osFile<span class="token punctuation">)</span> <span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Our GET part of the HTTP handler.</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Application<span class="token punctuation">)</span> <span class="token function">handleJSON</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodGet <span class="token punctuation">{</span><br>		w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><br><br>		filename <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> filename <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br>		fr<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>fs<span class="token punctuation">.</span><span class="token function">openFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ErrNotExist<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span><br>				<span class="token keyword">return</span><br>			<span class="token punctuation">}</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br><br>		buffer<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>fr<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br><br>		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><br>			<span class="token keyword">return</span><br>		<span class="token punctuation">}</span><br><br>		<span class="token keyword">return</span><br>    <span class="token punctuation">}</span> <span class="token comment">// Our POST request part</span></code></pre>
<p><em>main.go - the changes in main.go</em></p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f fakeFile<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> f<span class="token punctuation">.</span>buff<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token operator">...</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>ff <span class="token operator">*</span>fakeFiles<span class="token punctuation">)</span> <span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span><br>    	<span class="token comment">// We don't want to overwrite our writen file.</span><br>		<span class="token keyword">return</span> f<span class="token punctuation">,</span> <span class="token boolean">nil</span><br>	<span class="token punctuation">}</span><br>	ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> fakeFile<span class="token punctuation">{</span>buff<span class="token punctuation">:</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	<span class="token keyword">return</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go - updating opeFile return values and implement the fakeFile.Write method</em></p>
<p>Our test looks similar to the write test but instead we compare the response body to the bytes we put in the file.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestReadJSONFileFromDisk</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	files <span class="token operator">:=</span> <span class="token function">newFakeFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>Application<span class="token punctuation">{</span>fs<span class="token punctuation">:</span> files<span class="token punctuation">}</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	filename <span class="token operator">:=</span> <span class="token string">"test.json"</span><br>	f<span class="token punctuation">,</span> err <span class="token operator">:=</span>files<span class="token punctuation">.</span><span class="token function">openFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"can't write to test file"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	fileData <span class="token operator">:=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"{\"the_key\":\"is in this file\"}\n"</span><span class="token punctuation">)</span><br>	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"can't write to test file"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	endpoint <span class="token operator">:=</span> ts<span class="token punctuation">.</span>URL <span class="token operator">+</span> <span class="token string">"/json?file="</span> <span class="token operator">+</span> filename<br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"can't get response body: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">if</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> fileData<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"bytes read from file is not equal to input"</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go - our test for reading JSON files from disk</em></p>
<p><code>go test</code>, PASS! Our last point is returning a 404 Not Found if the file does not exist. This is actually easy and a problem at the same time. Easy because we already check if <code>os.ErrNotExist</code> is returned. Difficult because our fake filesystem doesn't support that.</p>
<p>Lets fix our fakeFiles.openFile method.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ff <span class="token operator">*</span>fakeFiles<span class="token punctuation">)</span> <span class="token function">openFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm os<span class="token punctuation">.</span>FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> f<span class="token punctuation">,</span> <span class="token boolean">nil</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">if</span> flag <span class="token operator">==</span> os<span class="token punctuation">.</span>O_RDONLY <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>ErrNotExist<br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><br>	ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> fakeFile<span class="token punctuation">{</span>buff<span class="token punctuation">:</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	<span class="token keyword">return</span> ff<span class="token punctuation">.</span>files<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span><br><br><span class="token operator">...</span><br><br><span class="token keyword">func</span> <span class="token function">TestFileDoesNotExist</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	files <span class="token operator">:=</span> <span class="token function">newFakeFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>Application<span class="token punctuation">{</span>fs<span class="token punctuation">:</span> files<span class="token punctuation">}</span><br>	ts <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token function">newRouter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> ts<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	endpoint <span class="token operator">:=</span> ts<span class="token punctuation">.</span>URL <span class="token operator">+</span> <span class="token string">"/json?file=not_here.json"</span><br>	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"request returned and error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusNotFound <span class="token punctuation">{</span><br>		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"status code is not %d, got %d"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>main_test.go - updating our fakeFiles.openFile method</em></p>
<p>Our final task completed with a quick confirmation with <code>go test .</code>.</p>
<h2>Conclusion</h2>
<p>That is it, we finished the tasks.</p>
<p>With the <code>httptest</code> package we incrementally added al the required behavior to the HTTP handler. By using dependency injection we the amount of cleanup we had to do while decreasing our coupling.</p>
<p>Note there are some problems that we haven't tackled yet.</p>
<ul>
<li>No logging at all</li>
<li>We don't check our path, so reading and writing from/to config and secrets on our server is possible</li>
<li>There is no upload limit</li>
<li>No content validation</li>
</ul>
<p>No worries, we can fix that in production, right? All jokes aside, I hope that this gives you an idea how to use the <code>httptest</code> package and use dependency injection to abstract away the interaction with the filesystem.</p>
</div>
      <div class="back-link">
        <a href="/">‚Üê Back</a>
      </div>
    </div>
  </body>
</html>
